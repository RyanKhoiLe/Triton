<!DOCTYPE HTML>
<html>
<head>
  <!-- created by Khoi Le 2016 !-->
  <title> Exhibit Editor </title>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="stylesheets/tritonEditCSS.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="icon" href="images/tritonIconSmall.png">
<script src="https://www.gstatic.com/firebasejs/3.3.0/firebase.js"></script>
</head>
<body>
  <script>
    // Initialize Firebase
    var config = {
      apiKey: "AIzaSyCH2GOoz3WtmgKC8gs9-P0eHk02-sX9vS0",
      authDomain: "lunaspheretriton.firebaseapp.com",
      databaseURL: "https://lunaspheretriton.firebaseio.com",
      storageBucket: "lunaspheretriton.appspot.com",
    };
    firebase.initializeApp(config);

  var url = "https://lunaspheretriton.firebaseio.com";
    var firebaseRef = firebase.database();


    var title, artist, summary, artistLastName, historyOfPainting, historyOfArtist, year, genre;
    var symbols;
    var videos;
    var exhibitImage, exhibitAudio, exhibitCode;
    var slides =[];

    var thisUrl = window.location.href;
    var keyStartAt = window.location.href.indexOf('?');
    var idStartAt = keyStartAt + 4;
    var fbID = thisUrl.substring(idStartAt);
    console.log(fbID);
    var fbIDFinal;
    if(fbID.includes('#')){
      console.log('there is a label or something in the html parameter');
      fbIDFinal = fbID.substring(0, fbID.indexOf('#'));
      fbID = fbID.substring(0, fbID.indexOf('#'));
      console.log(fbID);
    }
    else{
      fbIDFinal = fbID;
    }

    firebaseRef.ref('exhibits/' + fbIDFinal).on('value', function(snapshot) {
      var exhibitData = snapshot.val();
      //console.log(exhibitData);
      setContent(exhibitData);
    });
    function setContent(data){
      title = data.title;
      artist = data.artist;
      year = data.year;
      genre = data.genre;
      media = data.media;
      exhibitImage = data.exhibitImage;
      summary = data.summary;
      slides = data.slides;
      //console.log(summary);
      artistLastName = data.artist.substring(data.artist.indexOf(' ') + 1);
      symbols = data.symbols;
      historyOfPainting = data.historyOfPainting;
      historyOfArtist = data.historyOfArtist;
      exhibitAudio = data.exhibitAudio;
      exhibitCode = data.exhibitCode;
      //exhibitImage = data.exhibitImage;
      if(data.videos != null){
        //console.log("THERE ARE VIDEOS!");
        videos = data.videos;
      }
      setHTMLContent();
    }
    function setHTMLContent(){
      document.getElementById("exhibitCode").setAttribute('value', exhibitCode);
      document.getElementById("title").setAttribute('value', title);
      document.getElementById("artist").setAttribute('value', artist);
      document.getElementById("year").setAttribute('value', year);
      document.getElementById("genre").setAttribute('value', genre);
      document.getElementById("media").setAttribute('value', media);
      document.getElementById("exhibitImage").setAttribute("value", exhibitImage);
      document.getElementById("summary").textContent=summary;
      //var unorderedList = document.createElement("ul");
      document.getElementById("symbols").textContent=symbols;
      document.getElementById("historyOfPainting").textContent=historyOfPainting;
      document.getElementById("historyOfArtist").textContent=historyOfArtist;
      if(videos){
        document.getElementById("videos").textContent=videos;
      }

      var storage = firebase.storage();
      var storageRef = storage.ref();

      if(exhibitAudio != ''){
        //document.getElementById('exhibitAudio').style.display = 'block';
        //document.getElementById('exhibitAudio').style.float = 'none';
        document.getElementById("exhibitAudio").value = exhibitAudio;
          var spaceRefAudio = storageRef.child(exhibitAudio);
          storageRef.child(exhibitAudio).getDownloadURL().then(function(url){
            var test = url;
            //console.log(test);
            document.getElementById("exhibitAudioPreview").src = test;
          }).catch(function(error){

          });
      }

      if(exhibitImage != ''){
        //document.getElementById("lineUnderImage").style.display = 'block';
        var spaceRef = storageRef.child(exhibitImage);
        storageRef.child(exhibitImage).getDownloadURL().then(function(url){
          var test = url;
          document.getElementById("exhibitImagePreview").src = test;
          document.getElementById("exhibitImagePreview").style.display = 'inline';
        }).catch(function(error){

        });
      }
    }
    function getTimeStamp(){
      var now = new Date();
      var date = [now.getMonth() + 1, now.getDate(), now.getFullYear()];
      var time = [now.getHours(), now.getMinutes()];
      var suffix = (time[0] < 12) ? "AM" : "PM";
      time[0] = (time[0] < 12) ? time[0] : time[0] - 12;

      for(var i = 1; i < 3; i++){
        if(time[i] < 10) {
          time[i] = "0" + time[i];
        }
      }

      return date.join("/") + ", " + time.join(":") + " " + suffix;
    }
    function updatePage(){
      var title = document.getElementById("title").value,
      artist = document.getElementById("artist").value,
      year = document.getElementById("year").value,
      genre = document.getElementById("genre").value,
      media = document.getElementById("media").value,
      exhibitImage = document.getElementById("exhibitImage").value,
      summary = document.getElementById("summary").value,
      symbols = document.getElementById("symbols").value,
      historyOfArtist = document.getElementById("historyOfArtist").value,
      historyOfPainting = document.getElementById("historyOfPainting").value,
      videos = document.getElementById("videos").value,
      timeStamp = getTimeStamp(),
      exhibitAudio = document.getElementById("exhibitAudio").value,
      exhibitCode = document.getElementById("exhibitCode").value;
      //console.log('timeStamp: ' + timeStamp);

      if(title && artist && summary){
        firebaseRef.ref('exhibits/' + fbID).update({
            title: title,
            artist: artist,
            year: year,
            genre: genre,
            media: media,
            exhibitImage: exhibitImage,
            summary: summary,
            symbols: symbols,
            historyOfArtist: historyOfArtist,
            historyOfPainting: historyOfPainting,
            videos: videos,
            timeStamp: timeStamp,
            exhibitAudio: exhibitAudio,
            exhibitCode: exhibitCode
        });
        document.getElementById("exhibitPreview").setAttribute("src", "exhibit.html?id=" + fbID + '#edit');
        console.log(document.getElementById('exhibitPreview').src);
      }
      //document.getElementById('result').innerHTML = 'Congrats your page was updated';
    // }
    window.onscroll = function(){
      //console.log('scrollTop: ' + document.body.scrollTop);
      if(document.body.scrollTop > 290 && document.body.scrollTop < 3260){
        var showExhibit = document.getElementById("showExhibit");
        var jumpToBar = document.getElementById("jumpTo");
        jumpToBar.style.position = 'fixed';
        jumpToBar.style.top = '0px';
        style = showExhibit.style;
        style.position = 'fixed';
        style.marginLeft = '53%';
        style.top = '15px';
        style.marginTop = '0px';
      }
      if(document.body.scrollTop <= 290){
        var showExhibit = document.getElementById("showExhibit");
        style = showExhibit.style;
        style.position = 'static';
        style.marginLeft = '5%';
        var jumpToBar = document.getElementById("jumpTo");
        jumpToBar.style.position = 'static';
        jumpToBar.style.top = '0px';
      }
      if(document.body.scrollTop >= 3260){
        var showExhibit = document.getElementById("showExhibit");
        style = showExhibit.style;
        style.position = 'static';
        style.marginLeft = '5%';
        style.marginTop = '2900px';
      }
    }
    </script>
    <div id="headBar">
      <a href="www.lunasphere.com"><img id="lunasphereLogo" src="images/Logo.png" alt="Lunasphere"></a>
      <h1 id="pageTitle"> Exhibit Editor </h1>
      <a href="index.html"><img id="logoPageCreator" src="images/tritonIcon.png" alt="triton"></a>
      <div id="navBar">
        <a class="navBarLink" style="color: white" href="edithome.html"> database home </a>
        <a class="navBarLink" style="color: white" href="databaseExplorer.html"> database explorer </a>
      </div>
    </div>
    <div id="wrapper" style="border: 1px solid black">
      <div id="jumpTo">
        <h2 id="jumpToTitle"> Jump to: </h2>
        <a class="jumpToLinks" href="#titleLabel"> Title </a>
        <a class="jumpToLinks" href="#artistLabel"> Artist </a>
        <a class="jumpToLinks" href="#yearLabel"> Year </a>
        <a class="jumpToLinks" href="#genreLabel"> Genre </a>
        <a class="jumpToLinks" href="#mediaLabel"> Media </a>
        <a class="jumpToLinks" href="#exhibitImageLabel"> Image </a>
        <a class="jumpToLinks" href="#summaryLabel"> Summary </a>
        <a class="jumpToLinks" href="#symbolsLabel"> Symbols </a>
        <a class="jumpToLinks" href="#paintingHistoryLabel"> History of Painting </a>
        <a class="jumpToLinks" href="#artistHistoryLabel"> History of Artist </a>
        <a class="jumpToLinks" href="#videosLabel"> Videos </a>
      </div>
      <div id="centerBox">
      <form id="submitUpdate" action="#" onsubmit="event.preventDefault(); updatePage()">
        <div class="inputContainer">
            <div class="textContainer">

              <h2> Code: </h2>
            </div>
          <input type="text" id="exhibitCode" value="">
          <button class="update" type="submit"> Update Code </button>
        </div>
        <label id="titleLabel">
        <div class="inputContainer">
            <div class="textContainer">

              <h2> Title: </h2>
            </div>
          <input type="text" id="title" value="">
          <button class="update" type="submit"> Update Title </button>
        </div>
        <label id="artistLabel">
        <div class="inputContainer">
          <div class="textContainer">
            <h2> Artist: </h2>
          </div>
          <input type="text" id="artist" value="">
          <button class="update" type="submit"> Update Artist </button>
        </div>
        <label id="yearLabel">
        <div class="inputContainer">
            <div class="textContainer">
              <h2> Year: </h2>
            </div>
          <input type="text" id="year" value="">
          <button class="update" type="submit"> Update Year </button>
        </div>
        <label id="genreLabel">
        <div class="inputContainer">
            <div class="textContainer">
              <h2> Genre: </h2>
            </div>
          <input type="text" id="genre" value="">
          <button class="update" type="submit"> Update Genre </button>
        </div>
        <label id="mediaLabel">
        <div class="inputContainer">
            <div class="textContainer">
              <h2> Media: </h2>
            </div>
          <input type="text" id="media" value="">
          <button class="update" type="submit"> Update Media </button>
        </div>
        <div class="inputContainer">
          <h2 class="longDescription"> Audio (please select a high-quality .mp3 file and upload below).</h2> <h3> It should be successfully uploaded and say audio/[filename] in the box below: </h3><br>
          <input class='uploadFile' accept='audio/*' name='audioUpload' type='file' id='audioUpload'/>
          <p> Current audio: </p>
          <audio controls id="exhibitAudioPreview">
            Audio
          </audio>
          <label for='audioUpload' id='audioUploadLabel'>Choose a different file</label>
          <p id='percentUpload'>No file selected</p>
          <input type="text" id="exhibitAudio" style='float:none' placeholder="audio/[filename].mp3">
          <script>

            var imageUpload = document.getElementById("audioUpload");
            imageUpload.onchange = function(evt) {
              var firstFile = evt.target.files[0];
              var uploadConfirm = confirm("Upload: " + firstFile.name + "?");
              var uploadLabel = document.getElementById("audioUploadLabel");
              uploadLabel.innerHTML = firstFile.name;
              if(uploadConfirm){
                var storageRef = firebase.storage().ref("audio/" + firstFile.name);
                var uploadTask = storageRef.put(firstFile);
                uploadTask.on('state_changed', function(snapshot){
                  var percentUpload = document.getElementById("percentUpload");
                  percentUpload.textContent = "Uploading...";
                }, function(error){
                  alert("An error occurred: " + error);
                }, function() {
                  //alert("Successfully uploaded");
                  var percentUpload = document.getElementById("percentUpload");
                  percentUpload.textContent = "Successfully uploaded!";
                  var audioPath = document.getElementById("exhibitAudio");
                  audioPath.value = "audio/"+storageRef.fullPath;
                  console.log("successfully uploaded");
                });
              }
            };
          </script>
      </div>
        <label id="exhibitImageLabel">
          <div class="inputContainer">
            <h2 class="longDescription"> Image (please select a high-resolution photo and upload below).</h2> <h3> It should be successfully uploaded and say images/[filename] in the box below: </h3><br>
            <p> Current image: </p>
            <img id="exhibitImagePreview" width="90%" style="margin-bottom: 10px">
            <input class='uploadFile' accept='image/*' name='fileUpload' type='file' id='imageUpload'/>
            <label for='imageUpload' id='imageUploadLabel'>Choose a different file</label>
            <p id='percentUploadImage'>No file selected</p>
            <input type="text" id="exhibitImage" placeholder="images/[filename].jpg">
            <script>

              var imageUpload = document.getElementById("imageUpload");
              imageUpload.onchange = function(evt) {
                var firstFile = evt.target.files[0];
                var uploadConfirm = confirm("Upload: " + firstFile.name + "?");
                var uploadLabel = document.getElementById("imageUploadLabel");
                uploadLabel.innerHTML = firstFile.name;
                if(uploadConfirm){
                  var storageRef = firebase.storage().ref("images/" + firstFile.name);
                  var uploadTask = storageRef.put(firstFile);
                  uploadTask.on('state_changed', function(snapshot){
                    var percentUploadImage = document.getElementById("percentUploadImage");
                    percentUploadImage.textContent = "Uploading...";
                  }, function(error){
                    alert("An error occurred: " + error);
                  }, function() {
                    //alert("Successfully uploaded");
                    var percentUploadImage = document.getElementById("percentUploadImage");
                    percentUploadImage.textContent = "Successfully uploaded!";
                    var imagePath = document.getElementById("exhibitImage");
                    imagePath.value = "images/"+storageRef.name;
                    console.log("successfully uploaded"); //Khoi Le
                  });
                }
              };
            </script>


          </div>
        <label id="summaryLabel">
        <div class="inputContainer">
          <h2 class="longDescription"> Summary (Like a tweet! Capture the MOST interesting thing in a short but sweet summary): </h2>
          <textarea id="summary" rows="3" cols="50" value=""></textarea>
          <button class="update" type="submit"> Update Summary </button>
        </div>
        <label id="symbolsLabel">
        <div class="inputContainer">
          <h2 class="longDescription"> Major Symbols (Separate by commas): </h2>
          <textarea id="symbols" rows="3" cols="50" value=""></textarea>
          <button class="update" type="submit"> Update Symbols </button>
        </div>
        <label id="paintingHistoryLabel">
        <div class="inputContainer">
          <h2 class="longDescription"> History of the Painting (Give some context or background behind the era in which it was painted): </h2>
          <textarea id="historyOfPainting" rows="4" cols="50" value=""></textarea>
          <button class="update" type="submit"> Update Painting History </button>
        </div>
        <label id="artistHistoryLabel">
        <div class="inputContainer">
          <h2 class="longDescription"> History of the Artist (Give some context about the artist's life in relevance to this painting): </h2>
          <textarea id="historyOfArtist" rows="4" cols="50" value=""></textarea>
          <button class="update" type="submit"> Update Artist History </button>
        </div>
        <label id="videosLabel">
        <div class="inputContainer">
          <h2 class="longDescription"> Videos (please use YouTube videos and use the "Embed URL" link and paste below, separated by commas) If no videos, please leave blank </h2>
          <textarea id="videos" rows="3" cols="50" value=""></textarea>
          <button class="update" type="submit"> Update Videos </button>
        </div>
        <button id="updatePageButton" type="submit" style="font-size: 36px;">Update page</button>
      </form>
    </div>

      <div id="showExhibit">
        <h1 style='padding-top: 50px;'> Real-time preview </h1>
        <p> (make sure to click the update button to see changes): </p>
        <iframe id="exhibitPreview" width="90%" height="70%" src="exhibit.html?id=-KOzAZCrb_n_1LDbtTuV"></iframe>
        <script>
          var thisUrl = window.location.href;
          var keyStartAt = window.location.href.indexOf('?');
          var idStartAt = keyStartAt + 4;
          var fbID = thisUrl.substring(idStartAt);
          //console.log(fbID);
          var fbIDFinal;
          if(fbID.includes('#')){

            //console.log('there is a label or something in the html parameter');
            fbIDFinal = fbID.substring(0, fbID.indexOf('#'));
            fbID = fbID.substring(0, fbID.indexOf('#'));
            //console.log(fbID);
          }
          else{
            fbIDFinal = fbID;
          }
          document.getElementById("exhibitPreview").setAttribute("src", "exhibit.html?id=" + fbID + '#edit');
        </script>
      </div>
      <br>
      <br>
      <div></div>
    </div>
    <div id="footer">
      <div id="footerLinkBar">
        <a class="footerLinks" href="lunasphere.io"> about lunasphere </a>
        <a class="footerLinks" href="index.html"> triton database </a>
      </div>
      <div id="footerLogos">
        <h2 style="color: gray;">powered by <a class='h2Links' href='lunasphere.io'> LunaSphere </a> in conjunction with the <a class='h2Links' href='www.triton.org'>Triton Museum of Art</a>, Santa Clara, CA</h2>
        <img src='images/tritonIcon.png' id='logoPageCreatorFooter'></img>
        <img src='images/LogoTransparent.png' id='lunasphereLogoFooter'></img>
      </div>
      <div id="credits"> <h3 style='color:gray;'>Copyright 2016: Nikolai Flowers and Khoi Le </h3> </div>
    </div>


  </body>

</html>
