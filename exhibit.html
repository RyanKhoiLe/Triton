<!DOCTYPE HTML>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" type="text/css" href="stylesheets/tritonCSS.css">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="icon" href="images/tritonIconSmall.png">
  <script src="https://www.gstatic.com/firebasejs/3.2.1/firebase.js"></script>
</head>
<body>

  <script>
  var config = {
    apiKey: "AIzaSyCVFksGcDoYDk23wAG58XdYdfyDL7urzUY",
    authDomain: "learnfirebase-43e98.firebaseapp.com",
    databaseURL: "https://learnfirebase-43e98.firebaseio.com",
    storageBucket: "learnfirebase-43e98.appspot.com",
  };
  firebase.initializeApp(config);
  var url = "https://learnfirebase-43e98.firebaseio.com";
  var firebaseRef = firebase.database();
  var thisUrl = window.location.href;
  console.log(thisUrl);
  var keyStartAt = window.location.href.indexOf('?');
  var idStartAt = keyStartAt + 4;
  var fbID = thisUrl.substring(idStartAt);

  var title, artist, summary, artistLastName, historyOfPainting, historyOfArtist, year, genre;
  var symbols = [];
  var videos = [];
  var firstTimeLoad = false;
  console.log(fbID);
  //TO-DO SET EVENT TRIGGER TO ONCE SINCE IT IS STATIC UI
  firebaseRef.ref('exhibits/' + fbID).on('value', function(snapshot) {
    var exhibitData = snapshot.val();
    console.log(exhibitData);
    setContent(exhibitData);
  });
  function setContent(data){
    title = data.title;
    artist = data.artist;
    year = data.year;
    genre = data.genre;
    media = data.media;
    exhibitImage = data.exhibitImage;
    summary = data.summary;
    artistLastName = data.artist.substring(data.artist.indexOf(' ') + 1);
    symbols = data.symbols.split(',');
    historyOfPainting = data.historyOfPainting;
    historyOfArtist = data.historyOfArtist;
    if(data.videos != null){
      console.log("THERE ARE VIDEOS!");
      videos = data.videos.split(',');
    }
    setHTMLContent();
  }
  function setHTMLContent(){
    document.getElementById("headBarTitle").textContent = '' + title + ' - ' + artistLastName;
    document.getElementById("title").textContent = "Title: " + title;
    document.getElementById("artist").textContent = "Artist: " + artist;
    document.getElementById("year").textContent = "Year: " + year;
    document.getElementById("genre").textContent = "Genre: " + genre;
    document.getElementById("media").textContent = "Media: " + media;
    document.getElementById("exhibitImage").setAttribute("src", exhibitImage);
    document.getElementById("summary").textContent = summary;
    var unorderedList = document.createElement("ul");
    var listInSymbols = document.getElementById("symbols").appendChild(unorderedList);
    for(var i = 0; i < symbols.length; i++){
      var listNode = document.createElement("li");
      var node = document.createTextNode('' + symbols[i]);
      listNode.appendChild(node);
      listInSymbols.appendChild(listNode);
    }
    document.getElementById("historyOfPaintingHead").textContent = "History of " + title;
    document.getElementById("historyOfPainting").textContent = historyOfPainting;
    document.getElementById("historyOfArtistHead").textContent = "History of " + artist;
    document.getElementById("historyOfArtist").textContent = historyOfArtist;
    if(videos && firstTimeLoad === false){
      firstTimeLoad = true;
      for(var i = 0; i < videos.length; i++){
        var vidTitle = document.createElement("h2");
        var node = document.createTextNode("Video " + (i+1));
        vidTitle.appendChild(node);
        var iFrame = document.createElement("iframe");
        iFrame.setAttribute("class", "video");
        iFrame.setAttribute("src", videos[i]);
        iFrame.setAttribute("frameborder", "0");
        iFrame.setAttribute("allowfullscreen", true);
        var vidBox = document.getElementById("vidBox");
        vidBox.appendChild(vidTitle);
        vidBox.appendChild(iFrame);

      }
    }
  }
  function timeStamp(){
    var now = new Date();
    var date = [now.getMonth() + 1, now.getDate(), now.getFullYear()];
    var time = [now.getHours(), now.getMinutes()];
    var suffix = (time[0] < 12) ? "AM" : "PM";
    time[0] = (time[0] < 12) ? time[0] : time[0] - 12;

    for(var i = 1; i < 3; i++){
      if(time[i] < 10) {
        time[i] = "0" + time[i];
      }
    }

    return date.join("/") + ", " + time.join(":") + " " + suffix;
  }

  function postComment(){
    var name = document.getElementById("name").value,
    comment = document.getElementById("comment").value,
    time = timeStamp();
    var badWords = ["fuck", "shit", "cock", "dick", "pussy", "bitch", "ass", "<", ">"]; //excuse the language, gotta filter it out!
    for( var i = 0; i < badWords.length; i++){
      if(name.includes(badWords[i])){
        if(name.charAt(name.indexOf(badWords[i])) == 0){
          if(name.charAt(name.indexOf(badWords[i]) + 1) == ' ' || name.charAt(name.indexOf(badWords[i]) + 1) == ',' || name.charAt(name.indexOf(badWords[i]) + 1) == '.'){
            document.getElementById("comment").value += "\n I'm sorry, your name includes inappropriate language.";
            return;
          }
        }
        if(name.charAt(name.indexOf(badWords[i] - 1)) == " " && name.charAt(name.indexOf(badWords[i]) + badWords[i].length) == " "){
          document.getElementById("comment").value += "\n I'm sorry, your name includes inappropriate language.";
          return;
        }
        if(name.charAt(name.indexOf(badWords[i] - 1)) == " " && name.indexOf(badWords[i]) + badWords[i].length == name.length){
          document.getElementById("comment").value += "\n I'm sorry, your name includes inappropriate language.";
          return;
        }
      }
      if(comment.includes(badWords[i])){
        if(comment.charAt(comment.indexOf(badWords[i])) == 0){
          if(comment.charAt(comment.indexOf(badWords[i]) + 1) == ' ' || comment.charAt(comment.indexOf(badWords[i]) + 1) == ',' || comment.charAt(comment.indexOf(badWords[i]) + 1) == '.'){
            document.getElementById("comment").value += "\n I'm sorry, your comment includes inappropriate language.";
            return;
          }
        }
        if(comment.charAt(comment.indexOf(badWords[i] - 1)) == " " && comment.charAt(comment.indexOf(badWords[i]) + badWords[i].length) == " "){
          document.getElementById("comment").value += "\n I'm sorry, your comment includes inappropriate language.";
          return;
        }
        if(comment.charAt(comment.indexOf(badWords[i] - 1)) == " " && comment.indexOf(badWords[i]) + badWords[i].length == comment.length){
          document.getElementById("comment").value += "\n I'm sorry, your comment includes inappropriate language.";
          return;
        }
      }
    }

    if(name && comment){
      firebaseRef.ref('exhibits/' + fbID + '/comments').push({
        name: name,
        comment: comment,
        time: time
      });
    }

    document.getElementById("name").value = '';
    document.getElementById("comment").value = '';
  }
  var userComments = [];
  firebaseRef.ref('exhibits/' + fbID + '/comments').on("child_added", function(snapshot){
    var comment = snapshot.val();
    addComment(comment.name, comment.comment, comment.time);
  });
  function UserComment(name, comment, timeStamp){
    this.name = name;
    this.comment = comment;
    this.timeStamp = timeStamp;
  }
  function addComment(name, comment, timeStamp){
    var userComment = new UserComment(name, comment, timeStamp);
    userComments.push(userComment);
    var comments = document.getElementById("comments");
    var num = '' + userComments.indexOf(userComment);
    if(userComments.indexOf(userComment) > 0){
      var numMinusOne = '' + userComments.indexOf(userComment);
    }
    comments.innerHTML.replace("<button id='shareBtn" + numMinusOne +"' class='shareBtns'>SHARE</button>", '');
    comments.innerHTML = "<hr><h4>" + name + " says:</h4> <p id='commentText'>" + comment +"<h3>" + timeStamp + "</h3>" +
    "<button id='shareBtn" + num + "' class='shareBtns'>Share on FB</button>" + comments.innerHTML;
    document.getElementById("shareBtn" + num).onclick = function(){
      FB.ui({
        method: 'share',
        mobile_iframe: true,
        href: 'https://learnfirebase-43e98.firebaseapp.com/exhibit.html?id=' + fbID,
       quote: document.getElementById('commentText').textContent //'I just went to the Triton and saw Guernica, it was a fantastic painting!'
      }, function(response){});
    }
  }
  // document.title = '' +
  </script>
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&version=v2.7&appId=626508604175695";
    fjs.parentNode.insertBefore(js, fjs);
  }(document, 'script', 'facebook-jssdk'));</script>

  <div id="headBar">
    <h1 style="text-align: left" id="headBarTitle"> GUERNICA - PICASSO </h1>
    <a href="index.html"><img id="logo" src="images/tritonIcon.png" alt="triton"></a>
  </div>

  <div id = "wrapper">
    <div id="arrowBar">
      <a href='blue_radius.html'><img src='images/leftArrow.png' height='50px'></a>
      <a href='tracery_one.html'><img src='images/rightArrow.png' height='50px'></a>
    </div>
    <h2 id="title"> <strong> LOADING EXHIBIT PLEASE WAIT </strong> </h2>
    <h2 id="artist"><strong> LOADING EXHIBIT PLEASE WAIT </strong> </h2>
     <h2 id="year"> <strong> LOADING EXHIBIT PLEASE WAIT </strong> </h2>
    <h2 id="genre"><strong> LOADING EXHIBIT PLEASE WAIT </strong></h2>
   <h2 id="media"><strong> LOADING EXHIBIT PLEASE WAIT </strong> </h2>
    <audio controls>
      <source src="audio/Guernica.mp3" type="audio/mpeg">
      No audio for this browser
    </audio>

    <hr>
    <img id="exhibitImage" src="" width="60%">
    <hr>
    <h2> Summary </h2>
    <div id="summary"> LOADING EXHIBIT PLEASE WAIT </div>
    <hr>
    <h2> Major Symbols </h2>
    <div id="symbols" class="centeredList">
      LOADING EXHIBIT PLEASE WAIT
    </div>
    <hr>
    <h2 id="historyOfPaintingHead"> History </h2>
      <p id="historyOfPainting">history</p>
    <hr>
    <h2 id="historyOfArtistHead"> History </h2>
      <p id="historyOfArtist">history</p>
    <hr>
    <div id="vidBox"></div>
    <hr>
    <!-- <h2> Related Works </h2>
    <a href="https://en.wikipedia.org/wiki/The_Dream_and_Lie_of_Franco">The Dream and Lie of Franco</a><br>
    <a href="http://www.philamuseum.org/collections/permanent/51315.html"> Dali's Guernica </a>
    <hr>
     <a href="http://www.pablopicasso.org/guernica.jsp"> <h3>More on Guernica</h3> </a> -->
     <div class="container">
       <!-- <div class="header"> <h2>Comment and Post to Facebook <h2></div>
       <div class="fb-comments" data-href="http://ryankhoile.github.io/Triton/exhibit1.html" data-width="100%" data-numposts="20"></div> -->
       <div class="comment-box">
         <div class="comment-form">
           <div class="header"> <h2> Add a comment here <h2></div>
           <form action="#" onsubmit="event.preventDefault(); postComment()">
             <div>
               <input type="text" id="name" placeholder="Name">
             </div>
             <div>
               <textarea id="comment" rows="3" cols="30" placeholder="Comment"></textarea>
             </div>
             <button type="submit">POST</button>
           </form>
         </div>
         <div id="commentContainer">
           <h4 class="header">Comments</h4>
           <div id="comments"></div>
         </div>
       </div>
     </div>
    <img src="images/tritonLogo.png" alt="triton" height="50" style="padding-top: 15px; padding-bottom: 0px;">
    <div><a href="http://learnfirebase-43e98.firebaseapp.com/index.html">Return to main page</a></div>
  </div>
</body>
</html>
